<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autoclik Dual Sync (Final V12)</title> <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;800&family=Orbitron:wght@500;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { 
            --primary: #F3901D;             
            --primary-dark: #C67000; 
            --accent: #FFFFFF;             
            --bg-dark: #111111;
            --panel-bg: #1e1e1e;
            --text-main: #FFFFFF;    
            --text-light: #AAAAAA;   
            --border-color: #333;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
        }
        
        /* Reset Body for Perfect Fullscreen */
        body { 
            background: var(--bg-dark); color: var(--text-main); font-family: 'Kanit', sans-serif; 
            margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden;
            background-image: linear-gradient(rgba(0,0,0,0.9), rgba(0,0,0,0.95)), url('main_bg.jpg');
            background-size: cover; background-position: center;
        }

        /* =========================================
           CONTROLLER MODE (Dashboard Layout)
           ========================================= */
        body.controller-mode {
            overflow-y: auto;
            display: block;
            padding: 20px;
            height: auto; 
        }

        body.controller-mode .stage { display: none; }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
            height: calc(100vh - 40px);
            padding-bottom: 50px;
        }

        .panel {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            display: flex; flex-direction: column; gap: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .panel-header {
            font-size: 1.2rem; font-weight: bold; color: var(--primary);
            border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-bottom: 5px;
            text-transform: uppercase; letter-spacing: 1px;
        }

        .control-column { display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
        .data-column { display: flex; flex-direction: column; gap: 20px; overflow: hidden; }

        select, textarea, input[type="text"] {
            width: 100%; background: #2a2a2a; border: 1px solid #444; color: #fff;
            padding: 12px; border-radius: 6px; font-family: 'Kanit'; font-size: 1rem;
            outline: none; transition: border 0.3s; box-sizing: border-box;
        }
        /* Textarea scrolling */
        textarea#name-input {
            white-space: pre; 
            overflow-x: auto; 
            overflow-y: scroll;
        }

        select:focus, textarea:focus { border-color: var(--primary); }
        textarea { height: 120px; resize: vertical; }

        .dashboard-table-container {
            flex-grow: 1; overflow-y: auto;
            background: #252525; border-radius: 8px;
            border: 1px solid #333;
        }
        table { width: 100%; border-collapse: collapse; }
        th { background: #333; color: var(--primary); position: sticky; top: 0; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #444; color: #ddd; vertical-align: middle; }
        tr:nth-child(even) { background: #2a2a2a; }
        tr:hover { background: #333; }
        
        .promo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .promo-wrapper { position: relative; width: 100%; }
        .promo-thumb {
            width: 100%; aspect-ratio: 16/9; object-fit: cover; border-radius: 6px;
            cursor: pointer; border: 2px solid #444; transition: 0.2s; opacity: 0.6; display: block;
        }
        .promo-thumb:hover { opacity: 1; border-color: #666; }
        .promo-thumb.active-live {
            border: 3px solid #00ff00; opacity: 1;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.4); transform: scale(1.02);
        }
        
        .btn-delete-img {
            position: absolute; top: -5px; right: -5px;
            width: 24px; height: 24px;
            background: #dc3545; color: white;
            border-radius: 50%; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 0.8rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            transition: 0.2s;
            z-index: 10; border: 2px solid #fff;
        }
        .btn-delete-img:hover { transform: scale(1.1); background: #ff0000; }

        .btn-block {
            width: 100%; padding: 15px; border: none; border-radius: 8px;
            font-weight: bold; font-size: 1.1rem; cursor: pointer; color: #fff;
            transition: 0.2s; font-family: 'Kanit'; text-transform: uppercase;
        }
        .btn-open { background: var(--success); box-shadow: 0 4px 0 #1e7e34; margin-bottom: 10px; }
        .btn-open:active { transform: translateY(4px); box-shadow: none; }
        
        .btn-spin { background: linear-gradient(to right, var(--primary), #FF4500); box-shadow: 0 4px 0 var(--primary-dark); font-size: 1.5rem; }
        .btn-spin:active { transform: translateY(4px); box-shadow: none; }
        .btn-spin:disabled { background: #555; box-shadow: none; cursor: not-allowed; opacity: 0.6; transform: none; }
        
        .btn-stop { background: #dc3545; box-shadow: 0 4px 0 #a71d2a; display: none; font-size: 1.5rem; }
        
        .btn-reset { background: #444; color: #ccc; margin-top: 10px; font-size: 0.9rem; padding: 10px; }
        .btn-reset:hover { background: #d9534f; color: white; }

        .btn-save { background: #17a2b8; margin-top: 5px; font-size: 0.9rem; padding: 10px; }

        .btn-clear-effect {
            background: #6f42c1; color: white; margin-top: 10px; font-size: 1rem; padding: 12px;
            border: 1px solid #5a32a3; box-shadow: 0 3px 0 #4a2988;
        }
        .btn-clear-effect:hover { background: #5a32a3; }
        .btn-clear-effect:active { transform: translateY(3px); box-shadow: none; }

        /* Playlist Styles */
        .playlist-container {
            max-height: 120px; overflow-y: auto; background: #252525; 
            border: 1px solid #333; border-radius: 4px; margin-top: 5px;
        }
        .track-item {
            padding: 8px; border-bottom: 1px solid #333; cursor: pointer; font-size: 0.85rem;
            display: flex; justify-content: space-between; align-items: center;
        }
        .track-item:hover { background: #333; }
        .track-item.active-track { background: rgba(243, 144, 29, 0.2); color: var(--primary); border-left: 3px solid var(--primary); }
        .track-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
        
        .track-remove-btn { color: #888; font-weight: bold; padding: 0 5px; font-size: 1rem; }
        .track-remove-btn:hover { color: #dc3545; }

        .loop-controls { display: flex; gap: 5px; margin-top: 5px; }
        .btn-loop { flex: 1; padding: 5px; font-size: 0.8rem; background: #333; border: 1px solid #444; color: #888; cursor: pointer; border-radius: 4px; }
        .btn-loop.active { background: var(--primary); color: #000; font-weight: bold; border-color: var(--primary); }

        /* Excel Button Group */
        .btn-upload-excel {
            background: #217346; color: white; font-size: 0.9rem; padding: 8px; border-radius: 4px; border:none; cursor: pointer; width: 100%;
        }
        .btn-upload-excel:hover { background: #1e6b41; }
        
        /* New Column Mapping UI */
        .col-mapping-container {
            background: #252525; padding: 10px; border-radius: 4px; margin-bottom: 10px;
            border: 1px solid #333;
        }
        .mapping-row { display: flex; align-items: center; margin-bottom: 5px; justify-content: space-between; }
        .mapping-label { font-size: 0.85rem; color: #ccc; width: 80px; }
        .mapping-checks { display: flex; gap: 8px; }
        .mapping-check-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .mapping-check-item span { font-size: 0.7rem; color: #888; margin-bottom: 2px; }
        .mapping-check-item input { accent-color: var(--primary); }

        .btn-dq {
            background: transparent; border: 1px solid #dc3545; color: #dc3545;
            border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.8rem;
            transition: 0.2s;
        }
        .btn-dq:hover { background: #dc3545; color: #fff; }

        /* BGM Controls */
        .bgm-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px; }
        .btn-bgm { padding: 8px; border: none; border-radius: 4px; cursor: pointer; color: #fff; font-weight: bold; }
        .btn-bgm.play { background: #28a745; }
        .btn-bgm.stop { background: #dc3545; }
        .btn-bgm.fade { background: #ffc107; color: #000; } 
        .btn-bgm.fade-in { background: #17a2b8; color: #fff; } 
        
        .vol-container { grid-column: span 2; display: flex; align-items: center; gap: 10px; background: #252525; padding: 5px 10px; border-radius: 4px; margin-top: 5px; }
        input[type=range] { width: 100%; accent-color: var(--primary); cursor: pointer; }

        .status-badge {
            display: inline-block; padding: 5px 10px; border-radius: 20px;
            background: #333; color: #888; font-size: 0.8rem; margin-top: 5px;
        }
        .status-badge.connected { background: rgba(40, 167, 69, 0.2); color: #28a745; border: 1px solid #28a745; }

        /* =========================================
           RECEIVER MODE (General - STRICT FIX)
           ========================================= */
        body.receiver-mode { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            background: #000; 
            margin: 0; padding: 0;
            width: 100vw; height: 100vh;
            overflow: hidden !important; 
            position: fixed; 
            top: 0; left: 0;
        }
        body.receiver-mode .dashboard-grid { display: none !important; }
        
        /* Stage Base */
        .stage { 
            position: absolute; 
            overflow: hidden; 
            background-image: linear-gradient(rgba(0,0,0,0.9), rgba(0,0,0,0.95)), url('main_bg.jpg');
            background-size: cover; background-position: center;
            top: 50%; left: 50%;
            transform-origin: center center;
            box-shadow: 0 0 50px rgba(0,0,0,1);
            will-change: transform; 
        }
        
        .stage-scaler { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* =========================================
           HORIZONTAL LAYOUT (1920x1080)
           ========================================= */
        .stage.horizontal-layout { width: 1920px; height: 1080px; }

        .horizontal-layout .brand-logo { position: absolute; top: 40px; right: 50px; width: 300px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.5)); z-index: 50; }
        .horizontal-layout .acg-logo { position: absolute; top: 40px; left: 50px; width: 270px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.5)); z-index: 50; }

        /* Horizontal Prize Card */
        .horizontal-layout .prize-floating-card {
            position: absolute; top: 50%; left: 30px; transform: translateY(-50%); 
            width: 384px; height: 70vh; /* Fixed height to match sidebar */
            z-index: 60; text-align: center;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(10px);
            padding: 24px; border-radius: 30px;
            border: 2px solid rgba(255, 255, 255, 0.2); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; justify-content: flex-start; /* Align Top */
        }
        
        /* Horizontal Sidebar (IDENTICAL STYLE TO PRIZE CARD) */
        .horizontal-layout .winner-list-sidebar {
            position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
            width: 384px; height: 70vh; 
            /* Same style as prize-floating-card */
            background: rgba(0,0,0,0.4); backdrop-filter: blur(10px);
            border-radius: 30px; /* Matched radius */
            border: 2px solid rgba(255, 255, 255, 0.2); /* Matched border */
            padding: 24px; z-index: 40; display: flex; flex-direction: column; justify-content: flex-start;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); /* Matched shadow */
        }
        
        .horizontal-layout .gauge-container {
            position: absolute; left: 50%; top: 45%; transform: translate(-50%, -50%);
            width: 750px; height: 750px; 
            background-image: url('pattern.png'); background-size: contain; background-repeat: no-repeat; background-position: center;
            border-radius: 50%; box-shadow: 0 30px 70px rgba(0,0,0,0.9), inset 0 0 90px rgba(0,0,0,0.9);
            border: 8px solid #444; background-color: #111; z-index: 10;   
        }
        .horizontal-layout .odometer-box {
            position: absolute; left: 50%; top: 70%; transform: translateX(-50%);
            background: #000; border: 6px solid var(--primary); border-radius: 22px;
            padding: 20px 60px; 
            min-width: 680px; 
            width: auto; 
            max-width: 800px; /* <--- FIXED: Reduce width to ensure NO OVERLAP */
            text-align: center; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7); z-index: 20; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* =========================================
           VERTICAL LAYOUT (1080x1920)
           ========================================= */
        .stage.vertical-layout { width: 1080px; height: 1920px; }

        .vertical-layout .brand-logo { position: absolute; top: 30px; right: 30px; width: 250px; z-index: 50; }
        .vertical-layout .acg-logo { position: absolute; top: 30px; left: 30px; width: 220px; z-index: 50; }

        .vertical-layout .gauge-container {
            position: absolute; left: 50%; 
            top: 22%; 
            transform: translate(-50%, -50%);
            width: 805px; height: 805px; 
            background-image: url('pattern.png'); background-size: contain; background-repeat: no-repeat; background-position: center;
            border-radius: 50%; box-shadow: 0 30px 70px rgba(0,0,0,0.9), inset 0 0 90px rgba(0,0,0,0.9);
            border: 8px solid #444; background-color: #111; z-index: 10;
        }
        
        .vertical-layout .needle { height: 310px; width: 11px; }

        .vertical-layout .odometer-box {
            position: absolute; left: 50%; 
            top: 43%; 
            transform: translate(-50%, -50%);
            background: #000; border: 6px solid var(--primary); border-radius: 22px;
            padding: 30px; width: 950px; 
            text-align: center; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7); z-index: 20;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* Vertical Prize Card */
        .vertical-layout .prize-floating-card {
            position: absolute; top: 52%; bottom: auto; left: 45px; 
            width: 450px; height: 600px; transform: none; z-index: 60; text-align: center;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(10px);
            padding: 20px; border-radius: 30px;
            border: 2px solid rgba(255, 255, 255, 0.2); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; justify-content: flex-start; /* Align Top */
        }

        /* Vertical Sidebar (IDENTICAL STYLE TO PRIZE CARD) */
        .vertical-layout .winner-list-sidebar {
            position: absolute; top: 52%; bottom: auto; right: 45px; 
            width: 450px; height: 600px; max-height: 600px; transform: none; 
            /* Same style as prize-floating-card */
            background: rgba(0,0,0,0.4); backdrop-filter: blur(10px);
            border-radius: 30px; /* Matched radius */
            border: 2px solid rgba(255, 255, 255, 0.2); /* Matched border */
            padding: 20px; z-index: 40; display: flex; flex-direction: column; justify-content: flex-start;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); /* Matched shadow */
        }

        /* Building Image Overlay - UPDATED HEIGHT */
        .building-overlay {
            position: absolute;
            bottom: 90px; /* Above ticker */
            right: 0;
            width: auto;
            height: auto;
            max-height: 14vh; /* Fits in the bottom 15vh gap */
            z-index: 5; /* Background layer */
            pointer-events: none;
        }

        /* Common Elements */
        .prize-img-glow {
            max-width: 100%; max-height: 312px; width: auto; height: auto;
            object-fit: contain; display: block; margin: 0 auto 20px auto;        
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.3)); border-radius: 8px;
        }
        
        .prize-text-glow {
            font-family: 'Kanit', sans-serif; font-size: 2.2rem; 
            font-weight: 800; 
            color: var(--primary); /* ORANGE NAME */
            text-transform: none;  /* NO UPPERCASE for iPhone/iPad */
            text-shadow: 0 2px 5px rgba(0,0,0,0.9); 
            margin: 0; line-height: 1.1;
        }
        
        .prize-value-glow {
            font-family: 'Kanit', sans-serif; 
            font-size: 1.5rem; /* SMALLER */
            font-weight: 400; 
            color: #ffffff;    /* WHITE VALUE */
            margin-top: 15px;  /* NOT STUCK TOGETHER */
            display: block;    /* New Line */
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        .prize-qty-badge {
            display: inline-block; background: var(--primary); color: #000;
            padding: 6px 22px; border-radius: 30px; font-family: 'Kanit', sans-serif;
            font-weight: 800; font-size: 1.3rem; margin-top: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* Ensure winner-list-title doesn't collapse margins */
        .winner-list-title {
            color: var(--primary); font-size: 1.5rem; font-weight: 900; 
            font-family: 'Kanit', sans-serif; text-transform: uppercase; 
            margin-bottom: 20px; border-bottom: 2px solid #444;
            padding-bottom: 15px; text-align: center; letter-spacing: 1px;
            width: 100%; display: block;
        }
        
        .winner-list-items { 
            overflow-y: auto; display: flex; flex-direction: column; gap: 15px; flex: 1;
            -ms-overflow-style: none; scrollbar-width: none;  
        }
        .winner-list-items::-webkit-scrollbar { display: none; }

        /* MODIFIED WINNER ITEM LAYOUT */
        .winner-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px; background: rgba(255,255,255,0.08); border-radius: 12px;
            border-left: 6px solid var(--primary); animation: slideInRight 0.5s ease-out;
            overflow: hidden; flex-shrink: 0; 
        }
        @keyframes slideInRight { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .w-info-group {
            display: flex; flex-direction: column; align-items: flex-start; 
            flex: 1; min-width: 0; margin-right: 10px; /* Allow shrinking */
        }
        .w-line1-text {
            font-family: 'Kanit', sans-serif; font-weight: 600; font-size: 1.5rem; 
            color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%;
        }
        .w-line2-text {
            font-family: 'Kanit', sans-serif; font-size: 1rem; color: #ccc; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%;
        }

        .w-prize-right { 
            font-family: 'Kanit', sans-serif; font-size: 1.1rem; font-weight: 800;
            color: var(--primary); 
            white-space: normal; /* Allow Wrap */
            word-wrap: break-word; /* Wrap long words */
            text-align: right;
            flex: 0 0 35%; /* Fixed width 35% */
            line-height: 1.2;
        }

        .needle { 
            position: absolute; width: 9px; height: 270px; 
            background: linear-gradient(to top, var(--primary) 50%, #fff 100%); 
            top: 50%; left: 50%; transform-origin: bottom center; 
            transform: translate(-50%, -100%) rotate(-120deg);
            z-index: 10; border-radius: 50px 50px 0 0; 
            filter: drop-shadow(0 0 12px var(--primary)); transition: transform 0.1s linear; 
        }
        .center-cap { 
            width: 70px; height: 70px; background: #222; border: 5px solid var(--primary); 
            border-radius: 50%; position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); z-index: 11; box-shadow: 0 0 25px rgba(255,102,0,0.5);
        }

        .odometer-label { color: #FFFFFF; font-size: 1.35rem; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 8px; font-weight: bold; }
        
        #display-name {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; transition: filter 0.2s;
        }
        .winner-line-1 {
            font-family: 'Orbitron', monospace; font-size: 5rem; font-weight: 900; 
            color: var(--primary); /* Logo Orange */
            text-shadow: 0 0 15px rgba(255,255,255,0.1); white-space: nowrap; line-height: 1.1;
        }
        .winner-line-2 {
            font-family: 'Orbitron', monospace; font-size: 3rem; font-weight: 500; 
            color: #FFFFFF; /* White */
            white-space: nowrap; margin-top: 15px; line-height: 1.1;
        }

        .blur-fast { filter: blur(3px); opacity: 0.8; transform: scale(1.02); }

        #flash-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; opacity: 0; pointer-events: none; z-index: 999; }
        @keyframes flashAnim { 0% { opacity: 0; } 20% { opacity: 0.6; } 100% { opacity: 0; } }

        #promo-overlay {
            position: absolute; inset: 0; z-index: 500;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #promo-overlay.active { opacity: 1; pointer-events: auto; }
        #promo-image {
            max-width: 90%; max-height: 90%;
            border-radius: 15px; box-shadow: 0 30px 60px rgba(0,0,0,0.8);
            border: 3px solid var(--primary);
            transform: scale(0.9); transition: transform 0.4s cubic-bezier(0.17, 0.67, 0.33, 1.4);
        }
        #promo-overlay.active #promo-image { transform: scale(1); }

        .ticker-wrap {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 90px; 
            background: #111; border-top: 6px solid var(--primary);
            overflow: hidden; z-index: 90; display: flex; align-items: center;
            box-shadow: 0 -8px 25px rgba(0,0,0,0.8);
        }
        .ticker-content {
            display: inline-block; white-space: nowrap; padding-left: 100%; 
            animation-name: ticker; animation-iteration-count: infinite; animation-timing-function: linear;
            font-family: 'Kanit', sans-serif; 
            font-size: 3rem; 
            font-weight: 600; color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }

        /* MOVED BUTTONS LEFT and STACKED - UPDATED POSITIONING */
        .corner-btn {
            position: fixed; background: #222; color: var(--primary);
            border: 2px solid var(--primary); padding: 10px; border-radius: 12px;
            cursor: pointer; z-index: 200; transition: 0.3s; font-family: 'Kanit'; font-weight: bold;
            display: flex; align-items: center; justify-content: center; width: 60px; height: 60px; font-size: 1.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .corner-btn:hover { background: var(--primary); color: #fff; }
        
        /* Mute Button: Bottom Left, Above Ticker (110px) */
        .btn-mute { 
            bottom: 110px; 
            left: 30px; 
        }
        /* Fullscreen Button: Same level as Mute, moved to the right of it */
        .btn-fullscreen { 
            bottom: 110px; 
            left: 100px; /* 30px + 60px width + 10px gap */
            width: 60px; 
            padding: 0; 
        }

        /* Visual Effects */
        @keyframes shake-soft {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -1px) rotate(-1deg); }
            20% { transform: translate(-2px, 0px) rotate(1deg); }
            30% { transform: translate(2px, 1px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 1px) rotate(-1deg); }
            60% { transform: translate(-2px, 1px) rotate(0deg); }
            70% { transform: translate(2px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 1px) rotate(0deg); }
            100% { transform: translate(1px, -1px) rotate(-1deg); }
        }
        .shake-active { animation: shake-soft 0.1s infinite; }

        .supernova {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 0; height: 0;
            background: radial-gradient(circle, rgba(255,215,0,1) 0%, rgba(255,140,0,0.8) 40%, rgba(0,0,0,0) 80%);
            border-radius: 50%; z-index: 55; opacity: 0; pointer-events: none;
        }
        .supernova.silver {
            background: radial-gradient(circle, rgba(255,255,255,1) 0%, rgba(192,192,192,0.8) 40%, rgba(0,0,0,0) 80%);
        }
        @keyframes supernova-anim {
            0% { width: 0; height: 0; opacity: 1; }
            50% { width: 150vw; height: 150vw; opacity: 0.9; }
            100% { width: 250vw; height: 250vw; opacity: 0; }
        }
        .supernova-active { animation: supernova-anim 1.5s ease-out forwards; }

        @keyframes bg-jackpot {
            0% { background-color: rgba(255, 215, 0, 0.6); }      
            25% { background-color: rgba(255, 0, 0, 0.6); }        
            50% { background-color: rgba(255, 165, 0, 0.6); }      
            75% { background-color: rgba(255, 255, 0, 0.6); }      
            100% { background-color: rgba(255, 215, 0, 0.6); }     
        }
        @keyframes bg-tech {
            0% { background-color: rgba(255, 255, 255, 0.6); }      
            20% { background-color: rgba(0, 191, 255, 0.6); }       
            40% { background-color: rgba(0, 0, 128, 0.6); }           
            60% { background-color: rgba(128, 0, 128, 0.6); }       
            80% { background-color: rgba(192, 192, 192, 0.6); }     
            100% { background-color: rgba(255, 255, 255, 0.6); }
        }
        @keyframes bg-silver {
            0% { background-color: rgba(255, 255, 255, 0.6); }
            50% { background-color: rgba(192, 192, 192, 0.6); }
            100% { background-color: rgba(255, 255, 255, 0.6); }
        }
        .flash-silver { animation: bg-silver 0.5s infinite; }
        
        .aura-text-silver {
            color: #fff !important;
            text-shadow: 0 0 10px #C0C0C0, 0 0 20px #C0C0C0, 0 0 40px #A9A9A9, 0 0 80px #FFFFFF !important;
            animation: aura-pulse 0.5s infinite alternate;
        }

        .effect-bg-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 5; pointer-events: none;
            display: flex; justify-content: center; align-items: center;
            mix-blend-mode: screen; 
        }
        .flash-jackpot { animation: bg-jackpot 0.5s infinite; }
        .flash-tech { animation: bg-tech 0.5s infinite; }

        .sunburst {
            position: absolute; width: 200vmax; height: 200vmax;
            opacity: 0; transition: opacity 0.5s;
            animation: rotate-bg 20s linear infinite;
        }
        .sunburst.gold {
            background: repeating-conic-gradient(from 0deg, rgba(255, 215, 0, 0.2) 0deg, rgba(255, 215, 0, 0.2) 15deg, transparent 15deg, transparent 30deg);
        }
        .sunburst.white {
            background: repeating-conic-gradient(from 0deg, rgba(255, 255, 200, 0.15) 0deg, rgba(255, 255, 200, 0.15) 15deg, transparent 15deg, transparent 30deg);
        }
        @keyframes rotate-bg { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .sunburst.active { opacity: 1; }

        .speed-lines {
            position: absolute; width: 100%; height: 100%;
            background-size: 200% 200%;
            animation: zoom-lines 0.2s linear infinite; opacity: 0;
        }
        .speed-lines.gold {
            background: radial-gradient(circle, transparent 40%, rgba(255, 215, 0, 0.2) 41%, transparent 42%),
                        radial-gradient(circle, transparent 60%, rgba(255, 140, 0, 0.3) 61%, transparent 62%);
        }
        .speed-lines.normal {
            background: radial-gradient(circle, transparent 40%, rgba(255, 255, 255, 0.1) 41%, transparent 42%),
                        radial-gradient(circle, transparent 60%, rgba(200, 200, 255, 0.15) 61%, transparent 62%);
        }
        @keyframes zoom-lines { 0% { transform: scale(0.5); opacity: 0.5; } 100% { transform: scale(2.5); opacity: 0; } }
        .speed-lines.active { opacity: 1; }

        .aura-text {
            color: #fff !important;
            text-shadow: 0 0 10px #FFD700, 0 0 20px #FFD700, 0 0 40px #FF8C00, 0 0 80px #FF0000, 0 0 100px #FFFF00 !important;
            animation: aura-pulse 0.5s infinite alternate;
        }
        @keyframes aura-pulse { from { transform: scale(1); filter: brightness(1); } to { transform: scale(1.1); filter: brightness(1.5); } }

        @keyframes bounce-anim {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-30px);}
            60% {transform: translateY(-15px);}
        }
        .bounce-active .prize-floating-card { animation: bounce-anim 1.5s; }

        @keyframes zoom-in-anim {
            0% { transform: scale(0); opacity: 0; }
            60% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }
        .zoom-active .prize-img-glow, .zoom-active .prize-text-glow, .zoom-active .prize-value-glow {
            animation: zoom-in-anim 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        .spotlight-left, .spotlight-right {
            position: absolute; bottom: -100px; width: 150px; height: 1200px;
            filter: blur(30px); transform-origin: bottom center; opacity: 0;
            z-index: 50; pointer-events: none;
        }
        .spotlight-left { left: 10%; background: linear-gradient(to top, rgba(255, 255, 255, 0.6), transparent); animation: spot-l 2s infinite alternate; }
        .spotlight-right { right: 10%; background: linear-gradient(to top, rgba(255, 255, 255, 0.6), transparent); animation: spot-r 2s infinite alternate; }
        @keyframes spot-l { from { transform: rotate(25deg); } to { transform: rotate(-10deg); } }
        @keyframes spot-r { from { transform: rotate(-25deg); } to { transform: rotate(10deg); } }
        .spotlight-active { opacity: 1; }

        .fire-container {
            position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 150px; height: 450px; 
            pointer-events: none; z-index: 80;
        }
        .fire-particle {
            position: absolute; bottom: 0; width: 30px; height: 30px; 
            background: radial-gradient(circle, #ffeb3b, #ff9800, #f44336, transparent);
            border-radius: 50%; opacity: 0;
            animation: rise 1.5s ease-out forwards;
        }
        @keyframes rise {
            0% { bottom: 0; opacity: 1; transform: scale(1) translateX(0); }
            100% { bottom: 450px; opacity: 0; transform: scale(2) translateX(var(--drift)); }
        }

    </style>
</head>
<body class="controller-mode"> 

    <audio id="sfx-start" src="sound_start.mp3" preload="auto"></audio>
    <audio id="sfx-rev" src="sound_rev.mp3" loop preload="auto"></audio>
    <audio id="sfx-brake" src="sound_brake.mp3" preload="auto"></audio>
    <audio id="sfx-win" src="sound_win.mp3" preload="auto"></audio>
    <audio id="bgm-player" preload="auto"></audio>

    <div id="flash-overlay"></div>
    
    <div class="stage" id="main-stage">
        <div class="stage-scaler">
            <div id="promo-overlay">
                <img id="promo-image" src="" alt="Promotion">
            </div>

            <div class="ticker-wrap" id="ticker-wrap" style="display:none;">
                <div class="ticker-content" id="display-ticker-text">
                    ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° Autoclik Lucky Draw ‡∏•‡∏∏‡πâ‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏°‡∏≤‡∏Å‡∏°‡∏≤‡∏¢! ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡∏à‡∏≥‡∏Å‡∏±‡∏î 1 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ï‡πà‡∏≠ 1 ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ú‡∏π‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ 1 ‡∏ó‡πà‡∏≤‡∏ô‡∏ï‡πà‡∏≠ 1 ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• ‡∏Å‡∏£‡∏ì‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏∏‡πâ‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÅ‡∏£‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡∏•‡∏∏‡πâ‡∏ô‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÅ‡∏Ñ‡∏°‡πÄ‡∏õ‡∏ç‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• ‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ø ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• ‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏∏‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏•‡∏Å ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏î‡πâ ‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ø ‡∏Ç‡∏≠‡∏™‡∏á‡∏ß‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏î‡πÜ ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô‡∏™‡∏°‡∏Ñ‡∏ß‡∏£‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏£‡∏≤‡∏ö‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‡∏ó‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏û‡∏¥‡∏û‡∏≤‡∏ó ‡∏Ñ‡∏≥‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ø ‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
                </div>
            </div>

            <img src="‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£.png" class="building-overlay" alt="Building">

            <div class="supernova" id="supernova"></div>
            <div class="effect-bg-layer" id="effect-bg"></div> 
            <div class="spotlight-left" id="spot-l"></div>
            <div class="spotlight-right" id="spot-r"></div>
            
            <div class="fire-container" id="fire-l" style="left: 30%;"></div>
            <div class="fire-container" id="fire-r" style="left: 70%;"></div>

            <img src="logo2.png" class="acg-logo" alt="ACG">
            <img src="logo.png" class="brand-logo" alt="Autoclik" onerror="this.src='logo.png';">
            
            <div class="prize-floating-card" id="prize-card-container">
                <div class="winner-list-title">üéÅ ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div>
                
                <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%;">
                    <img id="stage-prize-img" src="" style="display:none;" class="prize-img-glow">
                    <h1 class="prize-text-glow" id="stage-prize-name">SELECT PRIZE</h1>
                    <div class="prize-value-glow" id="stage-prize-value"></div>
                    <div class="prize-qty-badge" id="stage-prize-qty">READY</div>
                </div>
            </div>

            <div class="winner-list-sidebar">
                <div class="winner-list-title">üèÜ ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div>
                <div class="winner-list-items" id="receiver-winner-list">
                </div>
            </div>

            <div class="gauge-container" id="gauge-container">
                <div class="needle" id="needle"></div>
                <div class="center-cap"></div>
            </div>
            <div class="odometer-box" id="odometer-box">
                <div class="odometer-label">LUCKY DRAW ODOMETER</div>
                <div id="display-name">
                    <div class="winner-line-1" id="display-name-line1">---</div>
                    <div class="winner-line-2" id="display-name-line2">READY</div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="display-controls" style="display:none;">
        <button class="corner-btn btn-mute" onclick="toggleMute()">üîä</button>
        <button class="corner-btn btn-fullscreen" id="btn-fs-toggle" onclick="togglePresentationMode()">‚õ∂</button>
    </div>

    <div class="dashboard-grid">
        
        <div class="control-column">
            
            <div class="panel" id="panel-connection">
                <div class="panel-header">1. ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>
                <button class="btn-block btn-open" onclick="openDisplay('horizontal')">üñ•Ô∏è ‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≠‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô (Horizontal)</button>
                <button class="btn-block btn-open" style="background: #6f42c1; box-shadow: 0 4px 0 #5a32a3;" onclick="openDisplay('vertical')">üì± ‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≠‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á (Vertical)</button>
                
                <div class="status-badge" id="conn-status">‚ö™ Waiting for connection...</div>
                <button class="btn-block btn-save" onclick="sendDataToChild()">üîÑ Force Sync All</button>
            </div>

            <div class="panel" id="panel-spin">
                <div class="panel-header">2. ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏∏‡∏ô</div>
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <div style="flex:1; color:#ccc; font-size:0.9rem; align-self:center;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏≤‡∏ô:</div>
                    <select id="spin-duration" style="flex:2; padding:8px;">
                        <option value="1000">üöÄ ‡πÄ‡∏£‡πá‡∏ß‡∏°‡∏≤‡∏Å (1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</option>
                        <option value="3000" selected>‚ö° ‡∏õ‡∏Å‡∏ï‡∏¥ (3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</option>
                        <option value="5000">üî• ‡∏ï‡∏∑‡πà‡∏ô‡πÄ‡∏ï‡πâ‡∏ô (5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</option>
                        <option value="8000">üò± ‡∏•‡∏∏‡πâ‡∏ô‡∏£‡∏∞‡∏ó‡∏∂‡∏Å (8 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</option>
                    </select>
                </div>
                
                <button class="btn-block btn-spin" id="btn-remote-start" onclick="remoteCommand('SPIN')">‚ñ∂Ô∏è SPIN START</button>
                <button class="btn-block btn-stop" id="btn-remote-stop" onclick="remoteCommand('STOP')">‚èπÔ∏è BRAKE / STOP</button>
                <button class="btn-block btn-clear-effect" onclick="remoteCommand('STOP_EFFECTS')">‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Ñ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (Stop Effects)</button>
                
                <div style="font-size:0.8rem; color:#888; text-align:center; margin-top:5px;">
                    ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <strong id="dash-prize-name" style="color:var(--primary)">-</strong><br>
                    ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span id="dash-prize-qty">-</span>
                </div>
            </div>

            <div class="panel" id="panel-data">
                <div class="panel-header">3. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• & ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</div>
                <select id="prize-selector" onchange="updatePrizeSelection()"></select>
                
                <div style="margin-top:10px; font-weight:bold; color:#ccc;">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Excel (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå):</div>
                
                <div class="col-mapping-container">
                    <div style="font-size:0.8rem; color:var(--primary); margin-bottom:5px; font-weight:bold;">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏ä‡πà‡∏≠‡∏á):</div>
                    
                    <div class="mapping-row">
                        <div class="mapping-label">‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ö‡∏ô:</div>
                        <div class="mapping-checks">
                            <label class="mapping-check-item"><span>A</span><input type="checkbox" class="chk-line1" value="0" checked onchange="handleMappingChange(this, 1)"></label>
                            <label class="mapping-check-item"><span>B</span><input type="checkbox" class="chk-line1" value="1" checked onchange="handleMappingChange(this, 1)"></label>
                            <label class="mapping-check-item"><span>C</span><input type="checkbox" class="chk-line1" value="2" onchange="handleMappingChange(this, 1)"></label>
                            <label class="mapping-check-item"><span>D</span><input type="checkbox" class="chk-line1" value="3" onchange="handleMappingChange(this, 1)"></label>
                            <label class="mapping-check-item"><span>E</span><input type="checkbox" class="chk-line1" value="4" onchange="handleMappingChange(this, 1)"></label>
                        </div>
                    </div>

                    <div class="mapping-row">
                        <div class="mapping-label">‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡πà‡∏≤‡∏á:</div>
                        <div class="mapping-checks">
                            <label class="mapping-check-item"><span>A</span><input type="checkbox" class="chk-line2" value="0" onchange="handleMappingChange(this, 2)"></label>
                            <label class="mapping-check-item"><span>B</span><input type="checkbox" class="chk-line2" value="1" onchange="handleMappingChange(this, 2)"></label>
                            <label class="mapping-check-item"><span>C</span><input type="checkbox" class="chk-line2" value="2" checked onchange="handleMappingChange(this, 2)"></label>
                            <label class="mapping-check-item"><span>D</span><input type="checkbox" class="chk-line2" value="3" onchange="handleMappingChange(this, 2)"></label>
                            <label class="mapping-check-item"><span>E</span><input type="checkbox" class="chk-line2" value="4" onchange="handleMappingChange(this, 2)"></label>
                        </div>
                    </div>
                </div>

                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <label class="btn-upload-excel" style="flex:1; margin-bottom:0; text-align:center; display:block;">
                        üìÑ ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î Excel
                        <input type="file" id="excel-input" accept=".xlsx" style="display:none" onchange="handleExcelUpload(event)">
                    </label>
                </div>

                <textarea id="name-input" placeholder="‡∏ß‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà... (1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î = 1 ‡∏ä‡∏∑‡πà‡∏≠)"></textarea>
                <div style="font-size:0.8rem; text-align:right;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: <span id="count" style="color:var(--primary)">0</span> ‡∏Ñ‡∏ô</div>
            </div>

            <div class="panel" id="panel-promo">
                <div class="panel-header">4. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</div>
                <label class="promo-uploader">
                    + ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (JPG/PNG)
                    <input type="file" id="promo-input" multiple accept="image/*" style="display:none" onchange="handlePromoUpload(event)">
                </label>
                <div class="promo-grid" id="promo-grid"></div>
                <div style="font-size:0.8rem; color:#666;">* ‡∏Å‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ä‡∏ß‡πå / ‡∏Å‡∏î‡∏ã‡πâ‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡∏•‡∏á</div>
            </div>

            <div class="panel" id="panel-ticker">
                <div class="panel-header">5. ‡πÅ‡∏ñ‡∏ö‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ß‡∏¥‡πà‡∏á (Ticker)</div>
                <textarea id="ticker-input" style="height:80px;" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ß‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà... (‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß)"></textarea>
                
                <div style="display:flex; align-items:center; gap:10px; margin-top:5px;">
                    <span style="font-size:0.8rem; color:#aaa;">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß:</span>
                    <input type="range" id="ticker-spd" min="5" max="600" value="80" style="flex:1;">
                    <span style="font-size:0.8rem; color:#aaa;">(‡πÄ‡∏£‡πá‡∏ß - ‡∏ä‡πâ‡∏≤)</span>
                </div>
                
                <button class="btn-block btn-save" style="margin-top:10px; background: #6f42c1;" onclick="sendTickerUpdate()">üì¢ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (Update)</button>
            </div>

            <div class="panel" id="panel-music">
                <div class="panel-header">6. Music & Sound (Playlist)</div>
                <div class="bgm-controls">
                    <label class="btn-bgm fade-in" style="grid-column: span 2; text-align:center;">
                          üìÇ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏•‡∏á (‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå)
                          <input type="file" style="display:none;" multiple accept="audio/*" onchange="handleBgmUpload(event)">
                    </label>
                    <button class="btn-bgm play" onclick="sendBGM('PLAY')">‚ñ∂ Play</button>
                    <button class="btn-bgm stop" onclick="sendBGM('STOP')">‚èπ Stop</button>
                    <button class="btn-bgm fade-in" onclick="sendBGM('FADE_IN')">Fade In</button>
                    <button class="btn-bgm fade" onclick="sendBGM('FADE_OUT')">Fade Out</button>
                </div>
                
                <div class="loop-controls">
                    <button class="btn-loop" id="btn-loop-one" onclick="setLoopMode('one')">üîÇ ‡∏ß‡∏ô‡πÄ‡∏û‡∏•‡∏á‡πÄ‡∏î‡∏¥‡∏°</button>
                    <button class="btn-loop active" id="btn-loop-all" onclick="setLoopMode('all')">üîÅ ‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå</button>
                </div>

                <div class="playlist-container" id="playlist-container">
                    <div style="padding:10px; color:#666; font-size:0.8rem; text-align:center;">-- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏û‡∏•‡∏á --</div>
                </div>

                <div class="vol-container">
                    <span style="font-size:0.8rem;">Vol:</span>
                    <input type="range" min="0" max="1" step="0.1" value="0.5" onchange="sendBGM('VOLUME', this.value)">
                </div>
            </div>

            <div class="panel" id="panel-system">
                <div class="panel-header">7. ‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡∏ï‡∏£‡∏∞‡∏ö‡∏ö ‡πÅ‡∏•‡∏∞‡πÄ‡∏≠‡πá‡∏Å‡∏û‡∏≠‡∏£‡πå‡∏ï‡πÑ‡∏ü‡∏•‡πå Excel</div>
                <button class="btn-block btn-reset" onclick="resetSystem()">‚ö†Ô∏è RESET FACTORY (Soft)</button>
                <button class="btn-block btn-save" style="background:#444;" onclick="exportWinners()">üì• EXPORT CSV</button>
            </div>

        </div>

        <div class="data-column">
            <div class="panel" style="height:100%; padding:0; overflow:hidden; display:flex; flex-direction:column;">
                <div style="padding:15px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
                    <div class="panel-header" style="border:none; margin:0;">üèÜ Real-time Winner Dashboard</div>
                    <div style="font-size:0.8rem; color:#888;">Updated: Live</div>
                </div>
                
                <div class="dashboard-table-container">
                    <table>
                        <thead>
                            <tr>
                                <th style="width:10%;">#</th>
                                <th style="width:35%;">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</th>
                                <th style="width:35%;">‡∏ú‡∏π‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ</th>
                                <th style="width:20%; text-align:center;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="dashboard-table-body">
                            <tr><td colspan="4" style="text-align:center; color:#666; padding:20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- CONSTANTS ---
        const WINDOW_BASE_NAME = 'AutoclikReceiver_Dual';

        // --- MODE DETECTION ---
        let isReceiver = false;
        let receiverMode = 'horizontal'; // 'horizontal' or 'vertical'
        let popupWindows = []; // Array to hold multiple window references
        let currentActiveImageSrc = null; 
        let connectionCheckInterval = null;

        // Music Playlist State
        let bgmPlaylist = []; // Array of { name: str, src: dataUrl }
        let currentTrackIndex = 0;
        let bgmLoopMode = 'all'; // Default to Loop All as requested
        
        // Debounce Lock for Winner Processing
        let lastWinTime = 0;
        
        // Synced Winner Variable
        let forcedTargetWinner = null;
        
        // Config for Display Lines (Indices)
        // Default: Line 1 = Col 0+1, Line 2 = Col 2
        let displayConfig = {
            line1: [0, 1],
            line2: [2]
        };

        if (window.opener) {
            isReceiver = true;
            document.body.classList.remove('controller-mode');
            document.body.classList.add('receiver-mode');
            
            // Check URL Params for mode
            const urlParams = new URLSearchParams(window.location.search);
            const modeParam = urlParams.get('mode');
            
            if (modeParam === 'vertical') {
                receiverMode = 'vertical';
                document.getElementById('main-stage').classList.add('vertical-layout');
                document.title = "Autoclik Display (Vertical)";
            } else {
                receiverMode = 'horizontal';
                document.getElementById('main-stage').classList.add('horizontal-layout');
                document.title = "Autoclik Display (Horizontal)";
            }

            document.getElementById('display-controls').style.display = 'flex';
            document.getElementById('ticker-wrap').style.display = 'flex';
        }

        // --- DATA STRUCTURE (UPDATED FOR NEW PRIZES & PRICES) ---
        const defaultPrizes = [
            { name: "iPhone 17 / 256GB", value: "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏•‡∏∞ 29,900 ‡∏ö‡∏≤‡∏ó", total: 1, current: 1 },
            { name: "iPad Gen11 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏ 128 GB / WIFI", value: "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏•‡∏∞ 12,900 ‡∏ö‡∏≤‡∏ó", total: 2, current: 2 },
            { name: "Xiaomi Robot Vacuum E5", value: "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏•‡∏∞ 3,990 ‡∏ö‡∏≤‡∏ó", total: 2, current: 2 },
            { name: "Xiaomi Smart Air Purifier 4 Compact", value: "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏•‡∏∞ 2,790 ‡∏ö‡∏≤‡∏ó", total: 4, current: 4 },
            { name: "Xiaomi Redmi Watch 5 Lite", value: "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏•‡∏∞ 1,990 ‡∏ö‡∏≤‡∏ó", total: 6, current: 6 },
            { name: "‡∏ö‡∏±‡∏ï‡∏£‡πÇ‡∏•‡∏ï‡∏±‡∏™ 500 ‡∏ö‡∏≤‡∏ó", value: "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏•‡∏∞ 500 ‡∏ö‡∏≤‡∏ó", total: 15, current: 15 },
            { name: "‡∏ö‡∏±‡∏ï‡∏£‡πÇ‡∏•‡∏ï‡∏±‡∏™ 300 ‡∏ö‡∏≤‡∏ó", value: "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏•‡∏∞ 300 ‡∏ö‡∏≤‡∏ó", total: 15, current: 15 }, 
            { name: "‡∏ö‡∏±‡∏ï‡∏£‡πÇ‡∏•‡∏ï‡∏±‡∏™ 200 ‡∏ö‡∏≤‡∏ó", value: "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏•‡∏∞ 200 ‡∏ö‡∏≤‡∏ó", total: 15, current: 15 },
            { name: "‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏û‡∏¥‡πÄ‡∏®‡∏©", value: "", total: 999, current: 999, isInfinite: true } 
        ];

        let prizesData = JSON.parse(JSON.stringify(defaultPrizes));
        let selectedPrizeIndex = 0;
        let names = []; 
        let winnersLog = []; 
        let isRunning = false; 
        let animationFrameId; 
        let isMuted = false;
        
        let tickerMessage = "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° Autoclik Lucky Draw ‡∏•‡∏∏‡πâ‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏°‡∏≤‡∏Å‡∏°‡∏≤‡∏¢! ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡∏à‡∏≥‡∏Å‡∏±‡∏î 1 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ï‡πà‡∏≠ 1 ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ú‡∏π‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ 1 ‡∏ó‡πà‡∏≤‡∏ô‡∏ï‡πà‡∏≠ 1 ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• ‡∏Å‡∏£‡∏ì‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏∏‡πâ‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÅ‡∏£‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡∏•‡∏∏‡πâ‡∏ô‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÅ‡∏Ñ‡∏°‡πÄ‡∏õ‡∏ç‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• ‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ø ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• ‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏∏‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ú‡∏•‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏•‡∏Å ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏î‡πâ ‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ø ‡∏Ç‡∏≠‡∏™‡∏á‡∏ß‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏î‡πÜ ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô‡∏™‡∏°‡∏Ñ‡∏ß‡∏£‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏£‡∏≤‡∏ö‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‡∏ó‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏û‡∏¥‡∏û‡∏≤‡∏ó ‡∏Ñ‡∏≥‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ø ‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î";
        let tickerSpeed = 80; 
        
        let currentTickerMsg = "";
        let currentTickerSpd = 0;
        
        let fadeInterval = null;
        let baseBgmVolume = 0.5;

        let activeEffects = { intervals: [], frames: [] };

        // Elements
        const elName = document.getElementById('display-name'); 
        const elNeedle = document.getElementById('needle');
        const prizeSelector = document.getElementById('prize-selector');
        
        const stagePrizeName = document.getElementById('stage-prize-name'); 
        const stagePrizeQty = document.getElementById('stage-prize-qty');
        const stagePrizeImg = document.getElementById('stage-prize-img'); 
        const stagePrizeValue = document.getElementById('stage-prize-value');

        const dashPrizeName = document.getElementById('dash-prize-name');    
        const dashPrizeQty = document.getElementById('dash-prize-qty');       
        const countDisplay = document.getElementById('count');
        const tableBody = document.getElementById('dashboard-table-body');
        
        const btnRemoteStart = document.getElementById('btn-remote-start');
        const btnRemoteStop = document.getElementById('btn-remote-stop');

        // Sounds
        const sndStart = document.getElementById('sfx-start'); 
        const sndRev = document.getElementById('sfx-rev');
        const sndBrake = document.getElementById('sfx-brake'); 
        const sndWin = document.getElementById('sfx-win');
        const sndBgm = document.getElementById('bgm-player');
        const allSounds = [sndStart, sndRev, sndBrake, sndWin, sndBgm];

        window.onload = function() {
            loadSystemState();
            initPrizeDropdown();
            updatePrizeSelection();
            updateCount();
            renderDashboard();
            
            // Init Checkboxes
            if(!isReceiver) updateMappingCheckboxes();
            
            document.getElementById('ticker-input').value = tickerMessage;
            document.getElementById('ticker-spd').value = tickerSpeed;

            if (isReceiver) {
                document.addEventListener('fullscreenchange', () => {
                    const btn = document.getElementById('btn-fs-toggle');
                    if (document.fullscreenElement) {
                        btn.innerText = "‚úñ"; 
                    } else {
                        btn.innerText = "‚õ∂"; 
                    }
                    setTimeout(resizeStage, 100);
                    setTimeout(resizeStage, 500); 
                });
                
                window.addEventListener('resize', resizeStage);
                resizeStage(); 

                allSounds.forEach(s => s.load());
                
                // FIXED: Better event handling for auto-next loop
                sndBgm.onended = () => {
                    if (window.opener && !window.opener.closed) {
                        window.opener.postMessage({ type: 'BGM_ENDED' }, '*');
                    }
                };
                
                if(currentTickerMsg !== tickerMessage || currentTickerSpd !== tickerSpeed) {
                    updateReceiverTicker(tickerMessage, tickerSpeed);
                    currentTickerMsg = tickerMessage;
                    currentTickerSpd = tickerSpeed;
                }
            } else {
                startConnectionMonitor();
                // MAIN FIX: Controller monitors its own audio to loop
                sndBgm.onended = handleBgmAutoNext;
            }
        };
        
        // --- HELPER: MAPPING LOGIC ---
        function handleMappingChange(checkbox, lineNum) {
            // Count checked
            const selector = lineNum === 1 ? '.chk-line1' : '.chk-line2';
            const checked = document.querySelectorAll(selector + ':checked');
            if (checkbox.checked && checked.length > 3) {
                alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡∏∞ 3 ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö');
                checkbox.checked = false;
                return;
            }
            
            // Update Config
            const newIndices = [];
            document.querySelectorAll(selector).forEach(chk => {
                if(chk.checked) newIndices.push(parseInt(chk.value));
            });
            
            if(lineNum === 1) displayConfig.line1 = newIndices;
            else displayConfig.line2 = newIndices;
            
            saveSystemState();
            sendDataToChild();
        }

        function updateMappingCheckboxes() {
            document.querySelectorAll('.chk-line1').forEach(chk => {
                chk.checked = displayConfig.line1.includes(parseInt(chk.value));
            });
            document.querySelectorAll('.chk-line2').forEach(chk => {
                chk.checked = displayConfig.line2.includes(parseInt(chk.value));
            });
        }
        
        // --- SMOOTH SCALING FUNCTION ---
        function resizeStage() {
            if(!isReceiver) return;
            const stage = document.getElementById('main-stage');
            if(!stage) return;
            
            let targetW = 1920, targetH = 1080;
            if (receiverMode === 'vertical') {
                targetW = 1080; targetH = 1920;
            }
            
            const winW = window.innerWidth;
            const winH = window.innerHeight;
            
            // Strict Aspect Ratio Scaling
            const scale = Math.min(winW / targetW, winH / targetH);
            
            stage.style.width = targetW + 'px';
            stage.style.height = targetH + 'px';
            stage.style.transform = `translate(-50%, -50%) scale(${scale})`;
        }

        // --- NEW RENDER LOGIC FOR 2 LINES ---
        function renderDisplayName(rawString) {
            const parts = rawString.split('|');
            const l1 = displayConfig.line1.map(i => parts[i] || '').join(' ').trim() || '---';
            const l2 = displayConfig.line2.map(i => parts[i] || '').join(' ').trim();
            
            document.getElementById('display-name-line1').innerText = l1;
            document.getElementById('display-name-line2').innerText = l2;
        }

        // --- SMART TEXT FIT (UPDATED FOR 2 LINES) ---
        function autoFitLines() {
            // Fit Line 1
            const line1 = document.getElementById('display-name-line1');
            const box = document.getElementById('odometer-box');
            let size1 = 5; // Start Rem
            line1.style.fontSize = size1 + 'rem';
            while (line1.scrollWidth > (box.clientWidth - 40) && size1 > 1.5) {
                size1 -= 0.1;
                line1.style.fontSize = size1 + 'rem';
            }
            
            // Fit Line 2
            const line2 = document.getElementById('display-name-line2');
            let size2 = 3; 
            line2.style.fontSize = size2 + 'rem';
            while (line2.scrollWidth > (box.clientWidth - 40) && size2 > 1.0) {
                size2 -= 0.1;
                line2.style.fontSize = size2 + 'rem';
            }
        }
        
        function autoFitText(el, container, initialSize) {
             let size = initialSize;
             el.style.fontSize = size + 'rem';
             while (el.scrollWidth > (container.clientWidth * 0.9) && size > 0.5) {
                 size -= 0.1;
                 el.style.fontSize = size + 'rem';
             }
        }

        window.addEventListener('message', (event) => {
            const data = event.data;
            if (!data || !data.type) return;

            if (isReceiver) {
                requestAnimationFrame(resizeStage);

                if (data.type === 'SYNC_DATA') {
                    document.getElementById('name-input').value = data.names;
                    prizesData = data.prizesData;
                    winnersLog = data.winnersLog;
                    initPrizeDropdown();
                    prizeSelector.value = data.selectedIndex;
                    
                    // Sync Config
                    if(data.displayConfig) displayConfig = data.displayConfig;

                    updatePrizeSelection(); 
                    updateCount();
                    renderReceiverWinnerList(); 
                    
                    if(data.tickerMsg !== currentTickerMsg || data.tickerSpd != currentTickerSpd) {
                        updateReceiverTicker(data.tickerMsg, data.tickerSpd);
                        currentTickerMsg = data.tickerMsg;
                        currentTickerSpd = data.tickerSpd;
                    }
                    
                    if(data.isReset) performSoftResetVisuals();
                } 
                else if (data.type === 'CMD_SPIN') phase1RevUp();
                else if (data.type === 'CMD_STOP') {
                    forcedTargetWinner = data.winner; 
                    phase2Drift(data.duration);
                }
                else if (data.type === 'CMD_STOP_EFFECTS') stopAllEffects();
                else if (data.type === 'CMD_PROMO') showPromo(data.imageData);
                else if (data.type === 'CMD_CLOSE_PROMO') closePromo();
                else if (data.type === 'CMD_BGM') handleBgmCommand(data);
                else if (data.type === 'CMD_TICKER') {
                    updateReceiverTicker(data.msg, data.spd);
                    currentTickerMsg = data.msg;
                    currentTickerSpd = data.spd;
                }
            } 
            else {
                if (data.type === 'REPORT_WIN') handleRemoteWin(data.winnerName);
                else if (data.type === 'BGM_ENDED') handleBgmAutoNext();
            }
        });

        // --- TICKER LOGIC ---
        function sendTickerUpdate() {
            const msg = document.getElementById('ticker-input').value;
            const spd = document.getElementById('ticker-spd').value;
            tickerMessage = msg;
            tickerSpeed = spd;
            
            broadcastMessage({ type: 'CMD_TICKER', msg: msg, spd: spd });
            saveSystemState();
        }

        function updateReceiverTicker(msg, spd) {
            const el = document.getElementById('display-ticker-text');
            if(!el) return;
            el.style.animation = 'none';
            el.offsetHeight; 
            el.style.animation = null; 
            el.innerText = msg;
            el.style.animationDuration = spd + 's';
        }

        function getPrizeImage(prizeName) {
            const prizeMappings = {
                "iPhone 17 / 256GB": "iPhone_17.png",
                "iPad Gen11 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏ 128 GB / WIFI": "iPad_128_GB_WIFI.png",
                "Xiaomi Robot Vacuum E5": "Xiaomi_Robot_Vacuum_E5.png",
                "Xiaomi Smart Air Purifier 4 Compact": "Xiaomi_Smart_Air_Purifier_4_Compact.png",
                "Xiaomi Redmi Watch 5 Lite": "Redmi watch 5 lite.png",
                "‡∏ö‡∏±‡∏ï‡∏£‡πÇ‡∏•‡∏ï‡∏±‡∏™ 500 ‡∏ö‡∏≤‡∏ó": "‡∏ö‡∏±‡∏ï‡∏£‡πÇ‡∏•‡∏ï‡∏±‡∏™_500_‡∏ö‡∏≤‡∏ó.png",
                "‡∏ö‡∏±‡∏ï‡∏£‡πÇ‡∏•‡∏ï‡∏±‡∏™ 300 ‡∏ö‡∏≤‡∏ó": "‡∏ö‡∏±‡∏ï‡∏£‡πÇ‡∏•‡∏ï‡∏±‡∏™ 300 ‡∏ö‡∏≤‡∏ó.png", 
                "‡∏ö‡∏±‡∏ï‡∏£‡πÇ‡∏•‡∏ï‡∏±‡∏™ 200 ‡∏ö‡∏≤‡∏ó": "‡∏ö‡∏±‡∏ï‡∏£‡πÇ‡∏•‡∏ï‡∏±‡∏™_200_‡∏ö‡∏≤‡∏ó.png",
                "‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏û‡∏¥‡πÄ‡∏®‡∏©": "‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏ò‡∏µ‡∏° autoclik.PNG"
            };
            return prizeMappings[prizeName] || "";
        }

        // --- CONTROLLER CONNECTION LOGIC (MULTI-WINDOW) ---
        function openDisplay(mode) {
            let width = 1920;
            let height = 1080;
            let windowName = WINDOW_BASE_NAME + '_' + mode;
            let urlParams = "";

            if (mode === 'vertical') {
                width = 540; // Preview size for controller
                height = 960;
                urlParams = "?mode=vertical";
            } else {
                width = 960; // Preview size
                height = 540;
                urlParams = "?mode=horizontal";
            }

            // Construct full URL
            let targetUrl = window.location.href.split('?')[0] + urlParams;

            let win = window.open(targetUrl, windowName, `width=${width},height=${height}`);
            
            if (win) {
                if (!popupWindows.includes(win)) {
                    popupWindows.push(win);
                }
                setTimeout(() => sendDataToChild(), 1000);
            } else {
                alert("‚ö†Ô∏è Popup ‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ö URL");
            }
        }

        function startConnectionMonitor() {
            if (connectionCheckInterval) clearInterval(connectionCheckInterval);
            connectionCheckInterval = setInterval(() => {
                // Filter out closed windows
                popupWindows = popupWindows.filter(win => win && !win.closed);
                
                const badge = document.getElementById('conn-status');
                if (popupWindows.length > 0) {
                    badge.innerHTML = `üü¢ Connected (${popupWindows.length} screens)`;
                    badge.classList.add('connected');
                } else {
                    badge.innerHTML = "‚ö™ Waiting for connection...";
                    badge.classList.remove('connected');
                }
            }, 1000);
        }

        function broadcastMessage(payload) {
            popupWindows.forEach(win => {
                if (win && !win.closed) {
                    win.postMessage(payload, '*');
                }
            });
        }

        function sendDataToChild(isReset = false) {
            const payload = {
                type: 'SYNC_DATA',
                names: document.getElementById('name-input').value,
                prizesData: prizesData,
                winnersLog: winnersLog,
                selectedIndex: prizeSelector.value,
                tickerMsg: tickerMessage,
                tickerSpd: tickerSpeed,
                displayConfig: displayConfig, // Send Config
                isReset: isReset
            };
            broadcastMessage(payload);
        }

        function remoteCommand(cmd) {
            if (cmd === 'SPIN' && names.length === 0) {
                alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°!");
                return;
            }

            if (popupWindows.length > 0) {
                if (cmd === 'SPIN') {
                    broadcastMessage({ type: 'CMD_SPIN' });
                    btnRemoteStart.style.display = 'none';
                    btnRemoteStop.style.display = 'inline-block';
                } else if (cmd === 'STOP') {
                    // CENTRALIZED RNG: Controller decides the winner!
                    const duration = parseInt(document.getElementById('spin-duration').value) || 3000;
                    const winnerIndex = Math.floor(Math.random() * names.length);
                    const forcedWinner = names[winnerIndex];
                    
                    broadcastMessage({ 
                        type: 'CMD_STOP', 
                        duration: duration,
                        winner: forcedWinner 
                    });
                    
                    btnRemoteStart.style.display = 'inline-block';
                    btnRemoteStop.style.display = 'none';
                } else if (cmd === 'STOP_EFFECTS') {
                    broadcastMessage({ type: 'CMD_STOP_EFFECTS' });
                }
            } else {
                if(!isReceiver && cmd !== 'CLOSE_PROMO') alert("‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•");
            }
        }

        function handleRemoteWin(winnerName) {
            // Debounce check: prevent double reporting from 2 screens
            const now = new Date().getTime();
            if (winnersLog.length > 0) {
                const lastLog = winnersLog[0];
                if (lastLog.rawValue === winnerName && (now - lastLog.timestamp < 5000)) {
                    return; // Duplicate report from another screen
                }
            }

            const prize = prizesData[selectedPrizeIndex];
            if (!prize.isInfinite) prize.current--;
            
            const originalQuota = names.filter(n => n === winnerName).length;
            names = names.filter(n => n !== winnerName);
            
            // Format Display Name
            // Note: Dashboard still shows simple pipe replace, or we can use mapping too
            const displayName = winnerName.replace(/\|/g, ' ');

            winnersLog.unshift({ 
                prize: prize.name, 
                name: displayName, 
                rawValue: winnerName, 
                timestamp: new Date().getTime(),
                quota: originalQuota
            });

            document.getElementById('name-input').value = names.join('\n');
            updatePrizeSelection();
            renderDashboard();
            updateCount();
            saveSystemState();
            sendDataToChild(); // Sync log to all screens
            
            btnRemoteStart.style.display = 'inline-block';
            btnRemoteStop.style.display = 'none';
        }

        function disqualifyWinner(index) {
            const winner = winnersLog[index];
            if(!confirm(`‚ùå ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ñ‡∏∏‡∏ì "${winner.name}" (‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•: ${winner.prize}) ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? \n(‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏∑‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)`)) return;

            const prizeObj = prizesData.find(p => p.name === winner.prize);
            if(prizeObj && !prizeObj.isInfinite) {
                prizeObj.current++; 
            }

            winnersLog.splice(index, 1);

            if(confirm(`‚Ü©Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏∑‡πà‡∏≠ "${winner.name}" ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? \n(‡∏Å‡∏î OK ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏∑‡πà‡∏≠ / ‡∏Å‡∏î Cancel ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏∑‡πà‡∏≠)`)) {
                const restoreCount = winner.quota || 1;
                const nameToRestore = winner.rawValue || winner.name;
                for(let i=0; i<restoreCount; i++) {
                    names.push(nameToRestore);
                }
                document.getElementById('name-input').value = names.join('\n');
                alert(`‚úÖ ‡∏Ñ‡∏∑‡∏ô‡∏ä‡∏∑‡πà‡∏≠ "${winner.name}" ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${restoreCount} ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
            }

            updatePrizeSelection();
            renderDashboard();
            updateCount();
            saveSystemState();
            sendDataToChild();
        }

        // --- MULTI-COLUMN EXCEL IMPORT ---
        function handleExcelUpload(event) {
            const file = event.target.files[0];
            if(!file) return;

            // REMOVED CHECKBOXES - ALWAYS READ 5 COLUMNS
            const cols = [0, 1, 2, 3, 4]; // Auto-read first 5 cols

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header:1});
                
                let extractedNames = [];
                jsonData.forEach(row => {
                    let parts = [];
                    cols.forEach(colIdx => {
                        if(row[colIdx] !== undefined && row[colIdx] !== null) {
                            parts.push(row[colIdx].toString().trim());
                        }
                    });
                    if(parts.length > 0) {
                        // Store full parts separated by pipe
                        extractedNames.push(parts.join('|'));
                    }
                });

                if(extractedNames.length > 0) {
                    const currentText = document.getElementById('name-input').value;
                    const separator = currentText.trim() === '' ? '' : '\n';
                    document.getElementById('name-input').value = currentText + separator + extractedNames.join('\n');
                    updateCount();
                    saveSystemState();
                    if(!isReceiver) sendDataToChild();
                    alert(`‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${extractedNames.length} ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠)`);
                } else {
                    alert(`‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•`);
                }
            };
            reader.readAsArrayBuffer(file);
            event.target.value = ''; 
        }

        // --- MUSIC PLAYLIST LOGIC (FIXED) ---
        function handleBgmUpload(event) {
            const files = event.target.files;
            if(!files || files.length === 0) return;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                reader.onload = function(e) {
                    bgmPlaylist.push({ name: file.name, src: e.target.result });
                    renderPlaylist();
                    
                    // If first track added, select it
                    if (bgmPlaylist.length === 1) {
                        currentTrackIndex = 0;
                        renderPlaylist(); 
                    }
                };
                reader.readAsDataURL(file);
            }
            // CRITICAL FIX: Reset value so same file can be selected again immediately
            event.target.value = '';
        }

        function renderPlaylist() {
            const container = document.getElementById('playlist-container');
            container.innerHTML = "";
            
            if (bgmPlaylist.length === 0) {
                container.innerHTML = '<div style="padding:10px; color:#666; font-size:0.8rem; text-align:center;">-- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏û‡∏•‡∏á --</div>';
                return;
            }

            bgmPlaylist.forEach((track, index) => {
                const div = document.createElement('div');
                div.className = `track-item ${index === currentTrackIndex ? 'active-track' : ''}`;
                div.innerHTML = `<span class="track-name">${index+1}. ${track.name}</span><span class="track-remove-btn" onclick="removeTrack(event, ${index})">‚ùå</span>`;
                div.onclick = (e) => {
                    // Prevent click if delete button was clicked
                    if (!e.target.classList.contains('track-remove-btn')) playTrack(index);
                };
                container.appendChild(div);
            });
        }
        
        function removeTrack(e, index) {
            e.stopPropagation(); 
            if(confirm('‡∏•‡∏ö‡πÄ‡∏û‡∏•‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                bgmPlaylist.splice(index, 1);
                // Adjust current index if needed
                if(index < currentTrackIndex) currentTrackIndex--;
                if(index === currentTrackIndex) {
                    // If deleted current track, stop music or play next if available
                      broadcastMessage({ type: 'CMD_BGM', action: 'STOP' });
                }
                renderPlaylist();
            }
        }

        function playTrack(index) {
            if (index < 0 || index >= bgmPlaylist.length) return;
            currentTrackIndex = index;
            renderPlaylist();
            
            // Loop Mode Logic sent to receiver
            // FIXED: Send correct loop state
            const isOneLoop = (bgmLoopMode === 'one');
            broadcastMessage({ type: 'CMD_BGM', action: 'LOAD', src: bgmPlaylist[index].src, loop: isOneLoop });
        }

        function setLoopMode(mode) {
            bgmLoopMode = mode;
            document.getElementById('btn-loop-one').classList.toggle('active', mode === 'one');
            document.getElementById('btn-loop-all').classList.toggle('active', mode === 'all');
            
            // Update current playing track loop status on fly if possible, or just next track
            const isOneLoop = (mode === 'one');
            broadcastMessage({ type: 'CMD_BGM', action: 'SET_LOOP', loop: isOneLoop });
        }

        function handleBgmAutoNext() {
            // FIXED: Logic for auto-next was missing safety check for empty playlist
            if (bgmPlaylist.length === 0) return;

            let nextIndex = currentTrackIndex;

            if (bgmLoopMode === 'one') {
                // Loop same track (Receiver handles this via native loop, but fallback here)
                nextIndex = currentTrackIndex;
            } else {
                // Loop all (Playlist flow)
                nextIndex = currentTrackIndex + 1;
                if (nextIndex >= bgmPlaylist.length) nextIndex = 0; 
            }
            
            playTrack(nextIndex);
        }

        function sendBGM(action, val) {
            if (action === 'PLAY') {
                if (bgmPlaylist.length > 0) playTrack(currentTrackIndex);
            } else {
                broadcastMessage({ type: 'CMD_BGM', action: action, value: val });
            }
        }

        function handleBgmCommand(data) {
            clearInterval(fadeInterval);
            const audio = document.getElementById('bgm-player');
            if(!audio) return;

            if(data.action === 'LOAD') {
                audio.src = data.src;
                audio.volume = baseBgmVolume;
                // FIXED: Set native loop property based on boolean
                audio.loop = (data.loop === true); 
                audio.load(); 
                // Autoplay Logic - Aggressive
                audio.autoplay = true; 
                var promise = audio.play();
                if (promise !== undefined) {
                    promise.catch(error => {
                        console.log("Autoplay prevented by browser policy (interact first)");
                    });
                }
            } else if (data.action === 'PLAY') {
                audio.volume = baseBgmVolume; 
                audio.play().catch(e => console.log("Audio Error:", e));
            } else if (data.action === 'STOP') {
                audio.pause();
                audio.currentTime = 0;
            } else if (data.action === 'SET_LOOP') {
                audio.loop = (data.loop === true); 
            } else if (data.action === 'VOLUME') {
                baseBgmVolume = parseFloat(data.value);
                if(!audio.paused) audio.volume = baseBgmVolume;
            } else if (data.action === 'FADE_IN') {
                audio.volume = 0;
                audio.play().catch(e => console.log("Audio Error:", e));
                fadeAudioTo(audio, baseBgmVolume, 2000, false);
            } else if (data.action === 'FADE_OUT') {
                fadeAudioTo(audio, 0, 2000, true);
            } else if (data.action === 'FADE') {
                fadeAudioTo(audio, 0, 1000, true);
            }
        }
        
        function fadeAudioTo(audioEl, targetVol, duration, stopAfter = false) {
            clearInterval(fadeInterval);
            const stepTime = 50;
            const stepVol = (targetVol - audioEl.volume) / (duration / stepTime);
            
            fadeInterval = setInterval(() => {
                let newVol = audioEl.volume + stepVol;
                if ((stepVol > 0 && newVol >= targetVol) || (stepVol < 0 && newVol <= targetVol)) {
                    newVol = targetVol;
                    clearInterval(fadeInterval);
                    if(stopAfter) {
                        audioEl.pause();
                        audioEl.currentTime = 0; 
                    }
                }
                if(newVol < 0) newVol = 0;
                if(newVol > 1) newVol = 1;
                audioEl.volume = newVol;
            }, stepTime);
        }

        function handlePromoUpload(event) {
            const files = event.target.files;
            const grid = document.getElementById('promo-grid');
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = e.target.result; 
                    
                    const wrapper = document.createElement('div');
                    wrapper.className = 'promo-wrapper';
                    
                    const img = document.createElement('img');
                    img.src = imageData;
                    img.className = 'promo-thumb';
                    img.onclick = () => togglePromo(img, imageData);
                    
                    const btnDel = document.createElement('div');
                    btnDel.className = 'btn-delete-img';
                    btnDel.innerHTML = '‚úï'; // Using nice symbol
                    btnDel.onclick = (e) => {
                        e.stopPropagation();
                        wrapper.remove();
                    };
                    
                    wrapper.appendChild(img);
                    wrapper.appendChild(btnDel);
                    grid.appendChild(wrapper);
                };
                reader.readAsDataURL(file);
            }
            // FIXED: Reset value so same file can be selected again
            event.target.value = '';
        }

        function togglePromo(imgElement, imageData) {
            if (isReceiver) return; 
            if (popupWindows.length === 0) { alert("‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•"); return; }

            if (currentActiveImageSrc === imageData) {
                broadcastMessage({ type: 'CMD_CLOSE_PROMO' });
                imgElement.classList.remove('active-live');
                currentActiveImageSrc = null;
            } else {
                document.querySelectorAll('.promo-thumb').forEach(el => el.classList.remove('active-live'));
                broadcastMessage({ type: 'CMD_PROMO', imageData: imageData });
                imgElement.classList.add('active-live');
                currentActiveImageSrc = imageData;
            }
        }

        function showPromo(imageData) {
            const overlay = document.getElementById('promo-overlay');
            const img = document.getElementById('promo-image');
            img.src = imageData;
            overlay.classList.add('active');
        }

        function closePromo() {
            document.getElementById('promo-overlay').classList.remove('active');
        }

        function renderDashboard() {
            if(isReceiver) return;
            tableBody.innerHTML = "";
            if (winnersLog.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#666; padding:20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞</td></tr>';
                return;
            }
            winnersLog.forEach((w, index) => {
                const tr = document.createElement('tr');
                const displayNum = winnersLog.length - index;
                tr.innerHTML = `
                    <td>${displayNum}</td>
                    <td style="color:#FF8800; font-weight:bold;">${w.prize}</td>
                    <td style="color:#fff;">${w.name}</td>
                    <td style="text-align:center;">
                        <button class="btn-dq" onclick="disqualifyWinner(${index})">‚ùå ‡∏™‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }
        
        // --- MODIFIED RECEIVER WINNER LIST LOGIC (FIXED AS REQUESTED) ---
        function renderReceiverWinnerList() {
            if(!isReceiver) return;
            const container = document.getElementById('receiver-winner-list');
            if(!container) return;
            container.innerHTML = "";
            const recent = winnersLog.slice(0, 100); 
            
            recent.forEach(w => {
                const div = document.createElement('div');
                div.className = 'winner-item';
                
                // Extract Line 1 and Line 2 from rawValue using current config
                const parts = w.rawValue.split('|');
                const l1 = displayConfig.line1.map(i => parts[i] || '').join(' ').trim();
                const l2 = displayConfig.line2.map(i => parts[i] || '').join(' ').trim();
                
                div.innerHTML = `
                    <div class="w-info-group">
                        <div class="w-line1-text">${l1 || w.name}</div>
                        <div class="w-line2-text">${l2}</div>
                    </div>
                    <div class="w-prize-right">${w.prize}</div>
                `;
                container.appendChild(div);
            });
        }

        function initPrizeDropdown() {
            const currentVal = prizeSelector.value;
            prizeSelector.innerHTML = "";
            prizesData.forEach((p, index) => {
                const option = document.createElement("option");
                option.value = index;
                option.text = p.name;
                prizeSelector.appendChild(option);
            });
            if(currentVal && currentVal < prizesData.length) prizeSelector.value = currentVal;
            else prizeSelector.value = 0;
        }

        function updatePrizeSelection() {
            selectedPrizeIndex = parseInt(prizeSelector.value);
            const prize = prizesData[selectedPrizeIndex];
            
            dashPrizeName.innerText = prize.name;
            if(stagePrizeName) stagePrizeName.innerText = prize.name;
            if(stagePrizeValue) stagePrizeValue.innerText = prize.value || "";
            
            if(stagePrizeImg) {
                // Image Mapping check
                const imageFile = getPrizeImage(prize.name);
                if (imageFile) {
                    stagePrizeImg.src = imageFile;
                    stagePrizeImg.style.display = 'block';
                } else {
                    stagePrizeImg.style.display = 'none';
                }
            }
            
            if (names.length === 0) {
                dashPrizeQty.innerText = "‡∏£‡∏≠‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...";
                dashPrizeQty.style.color = '#888';
                btnRemoteStart.disabled = true;
                btnRemoteStart.style.background = "#555";
                btnRemoteStart.style.cursor = "not-allowed";
                btnRemoteStart.innerText = "‚ö†Ô∏è ‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô";
                return; 
            }
            
            if (prize.isInfinite) {
                dashPrizeQty.innerText = "‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î (‚àû)";
                if(stagePrizeQty) {
                    stagePrizeQty.innerText = "‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î";
                    stagePrizeQty.style.background = "#9933cc";
                }
                btnRemoteStart.disabled = false;
                btnRemoteStart.style.background = "linear-gradient(to right, var(--primary), #FF4500)";
                btnRemoteStart.innerText = "‚ñ∂Ô∏è SPIN (FREE)";
            } else {
                const textQty = `${prize.current} / ${prize.total}`;
                dashPrizeQty.innerText = textQty;
                if(stagePrizeQty) {
                    stagePrizeQty.innerText = `‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${prize.current}`;
                    stagePrizeQty.style.background = (prize.current > 0) ? "var(--primary)" : "#dc3545";
                }

                if (prize.current <= 0) {
                    dashPrizeQty.style.color = 'red';
                    dashPrizeQty.innerText += " (‡∏´‡∏°‡∏î)";
                    btnRemoteStart.disabled = true;
                    btnRemoteStart.style.background = "#555";
                    btnRemoteStart.style.cursor = "not-allowed";
                    btnRemoteStart.innerText = "‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß (EMPTY)";
                } else {
                    dashPrizeQty.style.color = '#fff';
                    btnRemoteStart.disabled = false;
                    btnRemoteStart.style.background = "linear-gradient(to right, var(--primary), #FF4500)";
                    btnRemoteStart.style.cursor = "pointer";
                    btnRemoteStart.innerText = "‚ñ∂Ô∏è SPIN START";
                }
            }
        }

        document.getElementById('name-input').addEventListener('input', () => {
            updateCount();
            saveSystemState();
            if(!isReceiver) sendDataToChild();
        });
        
        prizeSelector.addEventListener('change', () => {
             updatePrizeSelection();
             saveSystemState();
             if(!isReceiver) sendDataToChild();
        });

        function updateCount() {
            const rawText = document.getElementById('name-input').value;
            const list = rawText.split('\n').filter(t => t.trim() !== '');
            countDisplay.innerText = list.length;
            names = list;
            updatePrizeSelection(); 
        }

        // --- STOP ALL EFFECTS FUNCTION ---
        function stopAllEffects() {
            activeEffects.intervals.forEach(clearInterval);
            activeEffects.frames.forEach(cancelAnimationFrame);
            activeEffects.intervals = [];
            activeEffects.frames = [];
            
            // Hard Reset Confetti
            try {
                if(window.confetti && window.confetti.reset) window.confetti.reset();
                const canvases = document.querySelectorAll('canvas');
                canvases.forEach(c => c.remove()); 
            } catch(e) { console.log(e); }

            document.getElementById('effect-bg').innerHTML = "";
            document.body.classList.remove('shake-active');
            document.getElementById('supernova').classList.remove('supernova-active', 'silver');
            document.getElementById('spot-l').classList.remove('spotlight-active');
            document.getElementById('spot-r').classList.remove('spotlight-active');
            
            const card = document.getElementById('prize-card-container');
            if(card) card.classList.remove('bounce-active', 'zoom-active');
            
            const dName = document.getElementById('display-name');
            if(dName) {
                // Reset Line 1 classes
                const dLine1 = document.getElementById('display-name-line1');
                if(dLine1) dLine1.classList.remove('aura-text', 'aura-text-silver');
            }
        }

        function performSoftResetVisuals() {
             // FIXED: REMOVED phase1RevUp() to prevent sound on reset
             // phase1RevUp(); 
             
             isRunning = false; 
             cancelAnimationFrame(animationFrameId);
             
             // Manually clear fire visuals since we don't call phase1RevUp
             document.getElementById('fire-l').innerHTML = "";
             document.getElementById('fire-r').innerHTML = "";

             stopAllEffects();
             document.getElementById('display-name-line1').innerText = "---";
             document.getElementById('display-name-line2').innerText = "READY";
             document.getElementById('odometer-box').classList.remove('blur-fast');
             elNeedle.style.transform = `translate(-50%, -100%) rotate(-120deg)`;
        }

        function phase1RevUp() {
            if (isReceiver) {
                stopAllEffects();
                document.getElementById('fire-l').innerHTML = "";
                document.getElementById('fire-r').innerHTML = "";

                isRunning = true;
                const box = document.getElementById('odometer-box');
                box.classList.add('blur-fast');
                
                // Set default spin text size
                document.getElementById('display-name-line1').style.fontSize = '5rem';
                document.getElementById('display-name-line2').style.fontSize = '3rem';

                clearInterval(fadeInterval); 
                if(!sndBgm.paused) fadeAudioTo(sndBgm, baseBgmVolume * 0.2, 500); 

                sndStart.currentTime = 0; sndStart.play();
                
                setTimeout(() => { if(isRunning) sndRev.play(); }, 600);
                
                let lastTime = 0;
                const revLoop = (timestamp) => {
                    if(!isRunning) return;
                    if (timestamp - lastTime > 30) {
                        const rawName = names[Math.floor(Math.random() * names.length)];
                        renderDisplayName(rawName);
                        lastTime = timestamp;
                    }
                    const vibration = 120 + Math.sin(timestamp / 20) * 5; 
                    elNeedle.style.transform = `translate(-50%, -100%) rotate(${vibration}deg)`;
                    animationFrameId = requestAnimationFrame(revLoop);
                };
                animationFrameId = requestAnimationFrame(revLoop);
            }
        }

        function phase2Drift(duration = 3000) {
            if (!isRunning) return;
            cancelAnimationFrame(animationFrameId);
            sndRev.pause(); sndRev.currentTime = 0; sndBrake.play();
            
            let startTime = null;
            let startAngle = 120;
            let endAngle = -120;
            const brakeLoop = (timestamp) => {
                if (!startTime) startTime = timestamp;
                const elapsed = timestamp - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                const ease = 1 - Math.pow(1 - progress, 3);
                
                const currentAngle = startAngle + (endAngle - startAngle) * ease;
                elNeedle.style.transform = `translate(-50%, -100%) rotate(${currentAngle}deg)`;
                
                if (Math.random() > ease * 0.8) { 
                      const rawName = names[Math.floor(Math.random() * names.length)];
                      renderDisplayName(rawName);
                      autoFitLines();
                }

                if (progress < 1) {
                    if(progress > 0.8) document.getElementById('odometer-box').classList.remove('blur-fast');
                    requestAnimationFrame(brakeLoop);
                } else {
                    finalizeWinner(); 
                }
            };
            requestAnimationFrame(brakeLoop);
        }

        function triggerAdvancedEffects(prizeName) {
            // First, clear everything just to be safe
            const bgLayer = document.getElementById('effect-bg');
            bgLayer.innerHTML = ""; 
            
            const card = document.getElementById('prize-card-container');
            card.classList.remove('zoom-active'); 
            void card.offsetWidth; 
            card.classList.add('zoom-active'); 
            
            const dLine1 = document.getElementById('display-name-line1');

            // TIER 1 (iPhone)
            if (prizeName.includes("iPhone 17 / 256GB")) {
                document.body.classList.add('shake-active'); 
                setTimeout(() => document.body.classList.remove('shake-active'), 5000); 
                document.getElementById('supernova').classList.add('supernova-active');
                dLine1.classList.add('aura-text');
                const flashBG = document.createElement('div');
                flashBG.className = 'flash-jackpot';
                bgLayer.appendChild(flashBG);
                const fireworksInt = setInterval(() => {
                    confetti({
                        particleCount: 100, startVelocity: 45, spread: 360,
                        origin: { x: Math.random(), y: Math.random() - 0.2 },
                        colors: ['#FFD700', '#FFA500', '#FFFFFF', '#FF0000']
                    });
                }, 500); 
                activeEffects.intervals.push(fireworksInt);
                (function coinFrame() {
                    confetti({
                        particleCount: 3, angle: 90, spread: 180, origin: { y: -0.1 },
                        colors: ['#FFD700'], shapes: ['circle'], scalar: 2, drift: 0
                    });
                    const id = requestAnimationFrame(coinFrame);
                    activeEffects.frames.push(id);
                }());
                const fireInt = setInterval(() => {
                    createFire(document.getElementById('fire-l'));
                    createFire(document.getElementById('fire-r'));
                }, 300); 
                activeEffects.intervals.push(fireInt);
            }
            // TIER 2: SILVER THEME
            else if (prizeName.includes("iPad Gen11 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏ 128 GB / WIFI") || prizeName.includes("‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏û‡∏¥‡πÄ‡∏®‡∏©")) {
                const isGold = true; 
                document.getElementById('supernova').classList.add('supernova-active');
                document.getElementById('supernova').classList.add('silver');
                
                dLine1.classList.add('aura-text-silver'); 
                
                const flashBG = document.createElement('div');
                flashBG.className = 'flash-silver'; 
                bgLayer.appendChild(flashBG);

                const fireworksInt = setInterval(() => {
                    confetti({
                        particleCount: 100, startVelocity: 45, spread: 360,
                        origin: { x: Math.random(), y: Math.random() - 0.2 },
                        colors: ['#C0C0C0', '#FFFFFF', '#A9A9A9', '#E0E0E0'] 
                    });
                }, 500); 
                activeEffects.intervals.push(fireworksInt);

                (function coinFrame() {
                    confetti({
                        particleCount: 3, angle: 90, spread: 180, origin: { y: -0.1 },
                        colors: ['#C0C0C0'], shapes: ['circle'], scalar: 2, drift: 0
                    });
                    const id = requestAnimationFrame(coinFrame);
                    activeEffects.frames.push(id);
                }());
            }
            // TIER 3.0: VACUUM
            else if (prizeName.includes("Vacuum")) {
                const flashBG = document.createElement('div');
                flashBG.className = 'flash-jackpot';
                bgLayer.appendChild(flashBG);
                const sunburst = document.createElement('div');
                sunburst.className = 'sunburst active gold'; 
                bgLayer.appendChild(sunburst);
                
                document.getElementById('spot-l').classList.add('spotlight-active');
                document.getElementById('spot-r').classList.add('spotlight-active');

                const colors = ['#E0FFFF', '#00FFFF', '#FFD700', '#FFFFFF']; 
                
                const ribbonInt = setInterval(() => {
                    if(receiverMode === 'vertical') {
                          confetti({ particleCount: 30, angle: 60, spread: 55, origin: { x: 0, y: 1 }, colors: colors, shapes: ['square'], scalar: 2, startVelocity: 70 });
                          confetti({ particleCount: 30, angle: 120, spread: 55, origin: { x: 1, y: 1 }, colors: colors, shapes: ['square'], scalar: 2, startVelocity: 70 });
                    } else {
                          confetti({ particleCount: 40, angle: 60, spread: 70, origin: { x: 0 }, colors: colors, shapes: ['square'], scalar: 2, drift: 1 });
                          confetti({ particleCount: 40, angle: 120, spread: 70, origin: { x: 1 }, colors: colors, shapes: ['square'], scalar: 2, drift: -1 });
                    }
                }, 300);
                activeEffects.intervals.push(ribbonInt);
            }
            // TIER 3.1: Air Purifier
            else if (prizeName.includes("Purifier")) {
                const flashBG = document.createElement('div');
                flashBG.className = 'flash-jackpot';
                bgLayer.appendChild(flashBG);
                
                const sunburst = document.createElement('div');
                sunburst.className = 'sunburst active white';
                bgLayer.appendChild(sunburst);
                
                document.getElementById('spot-l').classList.add('spotlight-active');
                document.getElementById('spot-r').classList.add('spotlight-active');

                const colors = ['#E0FFFF', '#00FFFF', '#FFD700', '#FFFFFF']; 
                
                const ribbonInt = setInterval(() => {
                    if(receiverMode === 'vertical') {
                          confetti({ particleCount: 30, angle: 60, spread: 55, origin: { x: 0, y: 1 }, colors: colors, shapes: ['square'], scalar: 2, startVelocity: 70 });
                          confetti({ particleCount: 30, angle: 120, spread: 55, origin: { x: 1, y: 1 }, colors: colors, shapes: ['square'], scalar: 2, startVelocity: 70 });
                    } else {
                          confetti({ particleCount: 40, angle: 60, spread: 70, origin: { x: 0 }, colors: colors, shapes: ['square'], scalar: 2, drift: 1 });
                          confetti({ particleCount: 40, angle: 120, spread: 70, origin: { x: 1 }, colors: colors, shapes: ['square'], scalar: 2, drift: -1 });
                    }
                }, 300);
                activeEffects.intervals.push(ribbonInt);
            }
            // TIER 3.2: Smart Watch
            else if (prizeName.includes("Watch")) {
                const flashBG = document.createElement('div');
                flashBG.className = 'flash-tech';
                bgLayer.appendChild(flashBG);
                
                const speedLines = document.createElement('div');
                speedLines.className = 'speed-lines active normal';
                bgLayer.appendChild(speedLines);
                
                document.getElementById('spot-l').classList.add('spotlight-active');
                document.getElementById('spot-r').classList.add('spotlight-active');

                const colors = ['#00BFFF', '#9932CC', '#C0C0C0', '#FFFFFF']; 
                
                const ribbonInt = setInterval(() => {
                    if(receiverMode === 'vertical') {
                          confetti({ particleCount: 40, angle: 80, spread: 80, origin: { x: 0, y: 1 }, colors: colors, scalar: 1.5, startVelocity: 80 });
                          confetti({ particleCount: 40, angle: 100, spread: 80, origin: { x: 1, y: 1 }, colors: colors, scalar: 1.5, startVelocity: 80 });
                    } else {
                          confetti({ particleCount: 50, angle: 60, spread: 80, origin: { x: 0 }, colors: colors, scalar: 1.5 });
                          confetti({ particleCount: 50, angle: 120, spread: 80, origin: { x: 1 }, colors: colors, scalar: 1.5 });
                    }
                }, 250); 
                activeEffects.intervals.push(ribbonInt);
            }
            // TIER 4
            else if (prizeName.includes("‡∏ö‡∏±‡∏ï‡∏£‡πÇ‡∏•‡∏ï‡∏±‡∏™")) {
                card.classList.remove('bounce-active');
                void card.offsetWidth;
                card.classList.add('bounce-active');
                let colors = [];
                if(prizeName.includes("500")) colors = ['#FFD700', '#FFA500', '#FF0000']; 
                else if(prizeName.includes("300")) colors = ['#00BFFF', '#1E90FF']; 
                else if(prizeName.includes("200")) colors = ['#FFFFFF', '#F0F8FF']; 
                confetti({ particleCount: 150, spread: 100, origin: { y: 0.6 }, colors: colors, shapes: ['square'] });
                (function paperFrame() {
                    confetti({
                        particleCount: 1, angle: 90, spread: 90, origin: { y: 0 },
                        colors: colors, shapes: ['square'], drift: 0.5, scalar: 1.2
                    });
                    const id = requestAnimationFrame(paperFrame);
                    activeEffects.frames.push(id);
                }());
            }
            else {
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            }
        }

        function createFire(container) {
            const p = document.createElement('div');
            p.className = 'fire-particle';
            p.style.left = Math.random() * 80 + '%';
            p.style.width = (10 + Math.random() * 20) + 'px';
            p.style.height = p.style.width;
            p.style.setProperty('--drift', (Math.random() * 100 - 50) + 'px');
            container.appendChild(p);
            setTimeout(() => p.remove(), 1500);
        }

        function finalizeWinner() {
            // Ensure visual state is clean before applying new winner effects
            stopAllEffects();

            let winnerName = forcedTargetWinner;
            if (!winnerName) {
                 const winnerIndex = Math.floor(Math.random() * names.length);
                 winnerName = names[winnerIndex];
            }
            const currentPrize = prizesData[selectedPrizeIndex];
            isRunning = false;
            
            renderDisplayName(winnerName);
            document.getElementById('odometer-box').classList.remove('blur-fast');
            elNeedle.style.transform = `translate(-50%, -100%) rotate(-120deg)`;
            
            autoFitLines();
            
            const flash = document.getElementById('flash-overlay');
            flash.style.animation = "flashAnim 0.5s ease-out";
            setTimeout(() => { flash.style.animation = ""; }, 500);
            
            triggerAdvancedEffects(currentPrize.name);
            
            let winSoundSrc = "sound_win.mp3"; 
            if (currentPrize.name.includes("iPhone 17 / 256GB")) winSoundSrc = "win1.mp3";
            else if (currentPrize.name.includes("iPad Gen11 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏ 128 GB / WIFI") || currentPrize.name.includes("Vacuum")) winSoundSrc = "win2.mp3";
            else if (currentPrize.name.includes("Purifier") || currentPrize.name.includes("Watch")) winSoundSrc = "win3.mp3";

            sndWin.src = winSoundSrc;
            sndWin.currentTime = 0;
            
            sndStart.pause(); sndStart.currentTime = 0;
            sndRev.pause(); sndRev.currentTime = 0;
            sndBrake.pause(); sndBrake.currentTime = 0;
            sndWin.volume = 1.0;
            sndWin.play().catch(e => console.log("Win sound error:", e));
            
            if(!sndBgm.paused) {
                setTimeout(() => {
                    fadeAudioTo(sndBgm, baseBgmVolume, 2000);
                }, 2000);
            }

            if (isReceiver && window.opener) {
                window.opener.postMessage({ type: 'REPORT_WIN', winnerName: winnerName }, '*');
            }
        }

        // --- UPDATED STORAGE KEY TO FORCE REFRESH ---
        function saveSystemState() {
            if (!isReceiver) {
                const state = {
                    names: document.getElementById('name-input').value,
                    prizesData: prizesData,
                    winnersLog: winnersLog,
                    selectedPrizeIndex: prizeSelector.value,
                    tickerMsg: tickerMessage,
                    tickerSpd: tickerSpeed,
                    displayConfig: displayConfig 
                };
                localStorage.setItem('autoclik_data_final_v12', JSON.stringify(state)); // Updated to V12
            }
        }

        function loadSystemState() {
            // Updated key 'autoclik_data_final_v12' to ensure new prizes load
            let saved = localStorage.getItem('autoclik_data_final_v12'); // Updated to V12
            
            if (saved) {
                const state = JSON.parse(saved);
                document.getElementById('name-input').value = state.names || "";
                if(state.prizesData) prizesData = state.prizesData;
                if(state.winnersLog) winnersLog = state.winnersLog;
                if(state.tickerMsg) tickerMessage = state.tickerMsg;
                if(state.tickerSpd) tickerSpeed = state.tickerSpd;
                if(state.displayConfig) displayConfig = state.displayConfig;
                
                if(state.selectedPrizeIndex !== undefined) {
                    setTimeout(() => {
                        prizeSelector.value = state.selectedPrizeIndex;
                        updatePrizeSelection();
                    }, 50);
                }
            }
        }

        // --- SOFT RESET (NO RELOAD) ---
        function resetSystem() {
            if(confirm("‚ö†Ô∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà)")) {
                // Clear all old keys to be safe
                const keys = ['autoclik_data_final_v12', 'autoclik_data_final_v11', 'autoclik_data_final_v10', 'autoclik_data_final_v9'];
                keys.forEach(k => localStorage.removeItem(k));
                
                prizesData = JSON.parse(JSON.stringify(defaultPrizes));
                names = [];
                winnersLog = [];
                selectedPrizeIndex = 0;
                document.getElementById('name-input').value = "";
                initPrizeDropdown();
                updatePrizeSelection();
                updateCount();
                renderDashboard();
                sendDataToChild(true);
            }
        }

        // --- EXPORT CSV (MODIFIED TO SEPARATE COLUMNS) ---
        function exportWinners() {
            if(winnersLog.length === 0) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞");
            
            // CSV Header updated
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF‡∏•‡∏≥‡∏î‡∏±‡∏ö,‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•,‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•1,‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•2,‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•3,‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•4,‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•5\n";
            [...winnersLog].reverse().forEach((w, index) => {
                // Split raw value back to columns
                const parts = w.rawValue.split('|');
                let line = `${index + 1},"${w.prize}"`;
                parts.forEach(p => { line += `,"${p}"`; });
                csvContent += line + "\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "autoclik_winners.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function toggleMute() {
            isMuted = !isMuted;
            allSounds.forEach(s => s.muted = isMuted);
            document.querySelector('.btn-mute').innerText = isMuted ? "üîá" : "üîä";
        }

        function togglePresentationMode() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err=>{});
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }
    </script>
</body>

</html>

